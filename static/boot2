print("boot2")

function fail()
  -- Sleep for 10 seconds
  os.sleep(10)
  os.reboot()
end
  
url = "http://localhost:34299/"
-- Download filelist
print(url.."listing")
h = http.get(url.."listing")
-- For line in h do

if h == nil then
  print("FAIL")
  fail()
else
  print("OK")
end

while true do
  line = h:readLine()
  if line == nil then 
    h:close()
    break 
  end
  
  print(url.."static/"..line)
  hnd = http.get(url.."static/"..line)
  
  if hnd == nil then
    print("FAIL")
    fail()
  end
  -- TODO: Strip the .lua off of the files
  f = io.open(line:sub(0,-5),"w")
  f:write(hnd:readAll())
  f:close()
  print("OK")
end

h = http.get(url.."startup")

if h == nil then
  print("Can't get startup")
  fail()
end

start = h:readAll()
h:close()

-- print(shell)
-- print(shell.getRunningProgram())
-- if shell.getRunningProgram() ~= "startup" and fs.exists("/startup") then
--   fs.delete("/startup")
--   fs.copy(shell.getRunningProgram(), "/startup")
-- end

-- TODO: exec?
if not pcall(function()
  os.loadAPI("log")

  local ok, msg = pcall(dofile(start))
  if ok then
    os.reboot()
    log.info("Payload exited cleanly")
    fail()
  else
    log.critical("Exception caught in payload")
    log.critical(msg)
    fail()
  end
end) then
  print("Holy crap, init failed!")
  fail()
end